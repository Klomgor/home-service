---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  TFTP_ROOT: "{{.ROOT_DIR}}/containers/tftpd/data/config"

tasks:

  default:
    silent: true
    cmd: go-task -l

  deps:
    desc: Install System Deps
    cmds:
      - sudo rpm-ostree update
      - sudo rpm-ostree upgrade
      - sudo rpm-ostree install --idempotent --assumeyes bind-utils git go-task htop nano net-tools netcat nmap moreutils rsync tcpdump telnet tree wget
      - curl -sL -o /tmp/1password-cli-latest.x86_64.rpm https://downloads.1password.com/linux/rpm/stable/x86_64/1password-cli-latest.x86_64.rpm
      - sudo rpm-ostree install /tmp/1password-cli-latest.x86_64.rpm
      - rm -rf /tmp/1password-cli-latest.x86_64.rpm

  start-*:
    desc: Start a container service
    cmds:
      - task: .reload
        vars: { container: "{{.container}}" }
      - sudo systemctl start {{.container}}
    vars:
      container: '{{index .MATCH 0}}'

  stop-*:
    desc: Stop a container service
    cmds:
      - task: .reload
        vars: { container: "{{.container}}" }
      - sudo systemctl stop {{.container}}
    vars:
      container: '{{index .MATCH 0}}'

  restart-*:
    desc: Restart a container service
    cmds:
      - task: .reload
        vars: { container: "{{.container}}" }
      - sudo systemctl restart {{.container}}
    vars:
      container: '{{index .MATCH 0}}'

  status-*:
    desc: Status of a container service
    cmds:
      - task: .reload
        vars: { container: "{{.container}}" }
      - sudo systemctl status {{.container}}
    vars:
      container: '{{index .MATCH 0}}'

  .reload:
    desc: Reload a container
    cmds:
      - sudo rsync -rv {{.ROOT_DIR}}/containers/{{.container}}/{{.container}}.container /etc/containers/systemd/
      - sudo rsync -rv --delete {{.ROOT_DIR}}/containers/{{.container}}/data/ /etc/containers/systemd/{{.container}}
      - sudo systemctl daemon-reload
    sources:
      - "{{.ROOT_DIR}}/containers/{{.container}}/**/**"
    generates:
      - /etc/containers/systemd/{{.container}}.container
      - /etc/containers/systemd/{{.container}}/config/**/**
      - /run/systemd/generator/{{.container}}.service
    requires:
      vars: ["container"]
    label: reload-{{.container}}
    internal: true

  tftpd:
    desc: Setup tftpd
    cmds:
      - curl -sL -o {{.TFTP_ROOT}}/undionly.kpxe http://boot.ipxe.org/undionly.kpxe
      - curl -sL -o {{.TFTP_ROOT}}/ipxe.efi http://boot.ipxe.org/ipxe.efi
      - curl -sL -o {{.TFTP_ROOT}}/ipxe-arm64.efi https://boot.ipxe.org/arm64-efi/ipxe.efi
      - task: restart-tftpd
